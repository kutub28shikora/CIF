<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CIF + ACS Widget</title>
  <script src="https://unpkg.com/@azure/communication-calling@next"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f6fb; }
    .container { background: #fff; border-radius: 8px; box-shadow: 0 2px 12px #0002; max-width: 340px; margin: 30px auto; padding: 26px 18px; }
    h2 { color: #0057b8; font-size: 1.2em; }
    button { background: #0057b8; color: #fff; border-radius: 6px; border: none; font-weight: bold; padding: 7px 18px; margin: 8px 4px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #status { margin-top: 14px; min-height: 24px; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ACS + Dynamics 365 Widget</h2>
    <div>
      <button id="simulateBtn">Simulate Incoming Call</button>
      <button id="answerBtn" disabled>Answer</button>
      <button id="hangupBtn" disabled>End Call</button>
      <button id="screenPopBtn" disabled>Screen Pop</button>
    </div>
    <div id="status"></div>
    <div style="margin-top:14px; font-size:11px; color:#999;">
      Hosted on GitHub Pages: <br>
      <a href="https://github.com/kutub28shikora/CIF" target="_blank">/kutub28shikora/CIF</a>
    </div>
  </div>
  <script>
    // --- ACS Setup ---
    // Replace with a valid user token for quick test purposes!
    const ACS_TOKEN = "<USER_ACCESS_TOKEN>";
    let callAgent, currentCall, incomingCall;

    // --- CIF Session ---
    let sessionId = null, phoneNumber = null;

    async function initACS() {
      if (!ACS_TOKEN || ACS_TOKEN.match(/[<>{}]/)) return; // Skip if not configured
      const callClient = new Azure.Communication.Calling.CallClient();
      const tokenCredential = new Azure.Communication.Calling.AzureCommunicationUserCredential(ACS_TOKEN);
      callAgent = await callClient.createCallAgent(tokenCredential);

      callAgent.on('incomingCall', async (args) => {
        incomingCall = args.incomingCall;
        phoneNumber = incomingCall.callerInfo.identifier.communicationUserId || "Unknown";
        sessionId = incomingCall.id;
        setStatus('Incoming ACS call');
        document.getElementById('answerBtn').disabled = false;
        document.getElementById('hangupBtn').disabled = true;
        document.getElementById('screenPopBtn').disabled = false;
        // Notify Dynamics
        if (window.parent.Microsoft && window.parent.Microsoft.CIFramework) {
          window.parent.Microsoft.CIFramework.addSession({
            sessionId,
            displayName: phoneNumber,
            channelType: "voice"
          });
        }
      });
    }

    // --- UI Logic ---
    document.getElementById('simulateBtn').onclick = () => {
      // Simulate incoming call for demo if not using real ACS
      phoneNumber = "+1" + Math.floor(1000000000 + Math.random()*9000000000);
      sessionId = "session-" + Date.now();
      setStatus("Simulated Incoming Call from " + phoneNumber);
      document.getElementById('answerBtn').disabled = false;
      document.getElementById('hangupBtn').disabled = true;
      document.getElementById('screenPopBtn').disabled = false;
      // Notify Dynamics
      if (window.parent.Microsoft && window.parent.Microsoft.CIFramework) {
        window.parent.Microsoft.CIFramework.addSession({
          sessionId,
          displayName: phoneNumber,
          channelType: "voice"
        });
      }
    };

    document.getElementById('answerBtn').onclick = async () => {
      setStatus("Call answered");
      document.getElementById('answerBtn').disabled = true;
      document.getElementById('hangupBtn').disabled = false;
      // Accept ACS call if real
      if (incomingCall) {
        currentCall = await incomingCall.accept();
      }
    };

    document.getElementById('hangupBtn').onclick = () => {
      setStatus("Call ended");
      document.getElementById('answerBtn').disabled = true;
      document.getElementById('hangupBtn').disabled = true;
      document.getElementById('screenPopBtn').disabled = true;
      if (window.parent.Microsoft && window.parent.Microsoft.CIFramework && sessionId) {
        window.parent.Microsoft.CIFramework.closeSession(sessionId);
      }
      if (currentCall) currentCall.hangUp();
      incomingCall = null; currentCall = null; sessionId = null;
    };

    document.getElementById('screenPopBtn').onclick = () => {
      if (window.parent.Microsoft && window.parent.Microsoft.CIFramework && phoneNumber) {
        window.parent.Microsoft.CIFramework.searchAndOpenRecords("contact", "telephone1", phoneNumber.replace(/\D/g, ""));
        setStatus("Screen pop for " + phoneNumber);
      }
    };

    function setStatus(msg) {
      document.getElementById('status').textContent = msg;
    }
    
    // Init ACS if token is set
    window.onload = initACS;
  </script>
</body>
</html>